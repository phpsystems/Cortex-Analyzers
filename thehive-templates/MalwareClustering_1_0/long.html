<div class="panel panel-danger" ng-if="!success">
    <div class="panel-heading">
        <strong>{{(artifact.data || artifact.attachment.name) | fang}}</strong>
    </div>
    <div class="panel-body">
        {{content.errorMessage}}
    </div>
</div>

<div ng-switch="content.response_code" ng-if="success">
    <div class="panel panel-info" ng-if="content.info">
        <div class="panel-heading">
            <strong>File Summary</strong>
        </div>
        <div class="panel-body">
            <dl class="dl-horizontal">
                <dt>Name</dt>
                <dd class="wrap">{{content.info.name}}</dd>
            </dl>
            <dl class="dl-horizontal" ng-if="content.info.tag">
                <dt>Family</dt>
                <dd class="wrap">{{content.info.tag}}</dd>
            </dl>
            <dl class="dl-horizontal">
                <dt>SHA-256</dt>
                <dd class="wrap">{{content.info.sha256}}</dd>
            </dl>
            <dl class="dl-horizontal">
                <dt>SHA-1</dt>
                <dd class="wrap">{{content.info.sha1}}</dd>
            </dl>            
            <dl class="dl-horizontal">
                <dt>MD5</dt>
                <dd class="wrap">{{content.info.md5}}</dd>
            </dl>            
            <dl class="dl-horizontal" ng-if="content.info.impfuzzy">
                <dt>Impfuzzy</dt>
                <dd class="wrap">{{content.info.impfuzzy}}</dd>
            </dl>            
            <dl class="dl-horizontal">
                <dt>ApiScout Vector</dt>
                <dd class="wrap">{{content.info.scout_result}}</dd>
            </dl>                  
            <dl class="dl-horizontal">
                <dt>ApiScout Confidence</dt>
                <dd class="wrap">{{content.info.scout_confidence}}</dd>
            </dl> 
        </div>
    </div>

    <div class="panel panel-info" ng-if="::content.families" ng-init="families_limit = 10" >
        <div class="panel-heading">
            <strong>Similar Families</strong>
            <span class="pull-right" ng-show="::content.families.length > 10">
                <a href ng-show="families_limit===10" ng-click="families_limit = undefined">Show All ({{::content.families.length}})</a>
                <a href ng-show="!families_limit" ng-click="families_limit = 10">Show less</a>
            </span>
        </div>
        <div class="panel-body">
            <p>Similar Families for ApiScout matchVectors</p>
            <table class="table table-hover">
                <tr>
                    <th>Family</th>
                    <th>Score</th>
                </tr>
                <tr ng-repeat="family in content.families | limitTo:families_limit">
                    <td><span ng-class="{'text-danger': family.max >= 70}">{{::family.tag}}</span></td>
                    <td><span ng-class="{'text-danger': family.max >= 70}">{{::family.max}}</span></td>
                </tr>
            </table>
        </div>
    </div>

    <div class="panel panel-info" ng-if="::content.files">
        <div class="panel-heading">
            <strong>Similar Sha256</strong>
        </div>
        <div class="panel-body">
            <table class="table table-hover">
                <tr>
                    <th>Family</th>
                    <th>Sha256</th>
                    <th>Score</th>
                </tr>
                <tr ng-repeat="file in content.files">
                    <td><span ng-class="{'text-danger': file.max >= 70}">{{file.tag}}</span></td>
                    <td><span ng-class="{'text-danger': file.max >= 70}">{{file.sha256}}</span></td>
                    <td><span ng-class="{'text-danger': file.max >= 70}">{{file.max}}</span></td>
                </tr>
            </table>
        </div>
    </div>

    <div style="display:none;" ng-if="::content.cluster">
        <script>
                         
            $(document).ready(function(){
            	$.when(
            		$.getScript("https://unpkg.com/@antv/g6/build/g6.js"),
					$.getScript("https://unpkg.com/@antv/g6/build/plugins.js"),
					$.getScript("https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.js"),
        			$.Deferred(function( deferred ){
        				$( deferred.resolve );
        			})
        		).done(function(){
                
                    function tableToJson(table) { 
                        var data = [];
                        var headers = []; 
                        for (var i=0; i<table.rows[0].cells.length; i++) {
                            headers[i] = table.rows[0].cells[i].innerHTML; 
                        } 
                        for (var i=1; i<table.rows.length; i++) { 
                            var tableRow = table.rows[i]; var rowData = {}; 
                            for (var j=0; j<tableRow.cells.length; j++) { 
                                rowData[ headers[j] ] = tableRow.cells[j].innerHTML; 
                            } data.push(rowData); 
                        } 
                        return data; 
                    }
        
                    function unique(array) {
                        return $.grep(array, function(el, index) {  
                            return index == $.inArray(el, array);
                        });
                    }
        
                    var table = tableToJson($('#cluster')[0]);
        
                    var families_list = [];
                    $.each(table, function(index, el) {
                        families_list.push(el['s_family']);
                        families_list.push(el['r_family']);
                    });
                    families_list = unique( families_list );

                    var sha256_list = [];
                    $.each(table, function(index, el) {
                        sha256_list.push(el['s_sha256']);
                        sha256_list.push(el['r_sha256']);
                    });
                    sha256_list = unique( sha256_list );

                    var nodes_list = [];
                    $.each(sha256_list, function(index, el){
                        nodes_list.push({'id': el});
                    });
        
                    var edges_list = [];
                    $.each(table, function(index, el){
                        edges_list.push({'target': el['r_sha256'], 'source': el['s_sha256'], 'label': el['Score']});
                    });
        
                    var data = { 'nodes': nodes_list, 'edges': edges_list };
        
                    let simulation;
                    const graph = new G6.Graph({
                        container: 'mountNode',
                        height: window.innerHeight,
                        modes: {
                            default: ['rightPanCanvas']
                        },
                        layout(nodes, edges) {
                            if (simulation) {
                                simulation.alphaTarget(0.3).restart();
                            } else {
                                simulation = d3.forceSimulation(nodes)
                                    .force('charge', d3.forceManyBody().strength(-100))
                                    .force('link', d3.forceLink(edges).id(model => {return model.id;}))
                                    .force('collision', d3.forceCollide().radius(90))
                                    .force('y', d3.forceY())
                                    .force('x', d3.forceX())
                                    .on('tick', () => {graph.updateNodePosition(); graph.emit('afterlayout');});
                            }
                        }
                    });
                    graph.node({
                      style(model) {
                        return {
                          fill: '#00aaff',
                          shadowColor: 'rgba(0,0,0, 0.3)',
                          shadowBlur: 3,
                          shadowOffsetX: 3,
                          shadowOffsetY: 5,
                          stroke: null
                        }
                      },
                      label(model) { return { text: model['id'].substring(0,7)+"...", stroke: null, fill: '#000' }; }
                      //label(model) { return { text: model['id'], stroke: null, fill: '#000' }; }
                    }).size(80);
                    graph.edge({ style() { return { stroke: '#b3b3b3', lineWidth: 2 } }});
                    graph.read(data);
                    graph.translate(graph.getWidth() / 2, graph.getHeight() / 2);

					let subject;
					graph.on('mousedown', ev => { if (ev.domEvent.button === 0) { subject = simulation.find(ev.x, ev.y); }});
					graph.on('dragstart', ev => { subject && simulation.alphaTarget(0.3).restart(); });
					graph.on('drag', ev => { if (subject) { subject.fx = ev.x; subject.fy = ev.y; }});
					graph.on('mouseup', resetState);
					graph.on('canvas:mouseleave', resetState);

					function resetState() {
  						if (subject) {
    						simulation.alphaTarget(0);
    						subject.fx = null;
    						subject.fy = null;
    						subject = null
  						}
					}

					const nodes = graph.getNodes();
					const edges = graph.getEdges();

					edges.forEach(edge => { edge.getGraphicGroup().set('capture', false); });

					graph.on('node:mouseenter', ev => {
  						const item = ev.item;
  						graph.toFront(item);
  						item.getLabel().show();
  						graph.draw();
					});

					graph.on('node:mouseleave', ev => {
  						const item = ev.item;
					});


        
            	});
            });
                 
        </script>
    
        <table id="cluster">
            <tr>
                <th>s_sha256</th>
                <th>s_family</th>
                <th>Score</th>
                <th>r_sha256</th>
                <th>r_family</th>
            </tr>
            <tr ng-repeat="node in content.cluster">
                <td>{{node['m2.sha256']}}</td>
                <td>{{node['m2.tag']}}</td>
                <td>{{node['p.value']}}</td>
                <td>{{node['m3.sha256']}}</td>
                <td>{{node['m3.tag']}}</td>
            </tr>
        </table>       
    </div>

    <div class="panel panel-info" ng-if="::content.cluster">
        <div class="panel-heading">
            <strong>Cluster Map</strong>
        </div>
        <div class="panel-body">        
            <div id="mountNode"></div>
        </div>
    </div>

    <div class="panel panel-info" ng-if="::content.cluster_count">
        <div class="panel-heading">
            <strong>Cluster Map</strong>
        </div>
        <div class="panel-body">        
            Cluster too big to be shown! {{content.cluster_count}} connections.
        </div>
    </div>    

</div>
